<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Shopease | Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/feather-icons"></script>

<style>
:root{
  --primary:#1E40AF;
  --accent:#3B82F6;
  --bg:#F4F6FB;
  --card:#fff;
  --text:#0F172A;
  --muted:#64748B;
  --border:rgba(0,0,0,.06);
  --radius:18px;
  --shadow:0 20px 40px rgba(30,64,175,.15);
}

*{box-sizing:border-box;font-family:Inter}
body{margin:0;background:var(--bg);color:var(--text)}

.topbar{
  height:70px;display:flex;align-items:center;justify-content:space-between;
  padding:0 28px;background:#fff;border-bottom:1px solid var(--border)
}

.logo{font-weight:700;font-size:20px;color:var(--primary)}

.user-info{display:none;align-items:center;gap:12px}
.user-info img{width:42px;height:42px;border-radius:50%}

.layout{display:grid;grid-template-columns:260px 1fr;min-height:calc(100vh - 70px)}

.sidebar{
  background:#fff;padding:24px;border-right:1px solid var(--border)
}
.sidebar a{
  display:flex;gap:12px;padding:14px;border-radius:14px;
  cursor:pointer;margin-bottom:6px
}
.sidebar a.active,.sidebar a:hover{background:#eef2ff;color:var(--primary)}
.sidebar a.locked{opacity:.45;cursor:not-allowed}

.main{padding:32px}

#greeting{display:none;font-size:28px;font-weight:700;margin-bottom:20px}

.stats{
  display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px
}
.stat{
  background:#fff;padding:20px;border-radius:18px;box-shadow:var(--shadow)
}

.panel{
  background:#fff;border-radius:18px;padding:30px;box-shadow:var(--shadow)
}
.section{display:none}
.section.active{display:block}

.profile-grid{
  display:grid;grid-template-columns:150px 1fr;gap:30px
}

.avatar img{
  width:120px;height:120px;border-radius:50%;
  background:#f1f5f9
}

input{
  width:100%;padding:14px;border-radius:14px;
  border:1px solid var(--border);margin-bottom:14px
}

button{
  padding:14px 22px;border:none;border-radius:14px;
  background:var(--primary);color:#fff;cursor:pointer
}

/* ===== LOGIN MODAL ===== */
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.45);
  display:none;align-items:center;justify-content:center
}
.modal{
  background:#fff;padding:30px;border-radius:18px;width:360px;
  text-align:center;box-shadow:var(--shadow)
}
.modal button{width:100%;margin-top:16px}

.section{
  animation: fade .35s ease;
}
@keyframes fade{
  from{opacity:0;transform:translateY(12px)}
  to{opacity:1;transform:none}
}

</style>
</head>

<body>

<!-- ===== TOP BAR ===== -->
<div class="topbar">
  <div class="logo">Shopease</div>
  <div class="user-info" id="userBox">
    <img id="topAvatar">
    <strong id="topName"></strong>
  </div>
</div>

<div class="layout">

<!-- ===== SIDEBAR ===== -->
<aside class="sidebar">
  <a class="active" data-section="profile">Profile</a>
  <a class="locked" data-section="orders">Orders</a>
  <a class="locked" data-section="security">Security</a>
  <a onclick="logout()">Logout</a>
</aside>

<!-- ===== MAIN ===== -->
<main class="main">

  <div id="greeting">Hello, <span id="greet"></span> ðŸ‘‹</div>

  <div class="stats">
    <div class="stat"><strong id="points">--</strong><div class="muted">Points</div></div>
    <div class="stat"><strong id="ordersCount">--</strong><div class="muted">Orders</div></div>
    <div class="stat"><strong id="lifetime">--</strong><div class="muted">Lifetime</div></div>
    <div class="stat"><strong>Guest</strong><div class="muted">Status</div></div>
  </div>

  <div class="panel">

    <div class="section active" id="profile">
      <div class="profile-grid">
        <div class="avatar">
          <img id="avatar">
        </div>
        <div>
          <input id="name" placeholder="Name" disabled>
          <input id="email" placeholder="Email" disabled>
          <button onclick="save()">Save Changes</button>
        </div>
      </div>
    </div>

    <div class="section" id="orders">
  <h3>Your Orders</h3>
  <ul id="ordersList"></ul>
</div>


    <div class="section" id="security">
  <input id="oldPass" placeholder="Old Password" type="password">
  <input id="newPass" placeholder="New Password" type="password">
  <button onclick="changePass()">Update Password</button>
</div>


  </div>
</main>
</div>

<!-- ===== LOGIN OVERLAY ===== -->
<div class="overlay" id="loginOverlay">
  <div class="modal">
    <h3>Login Required</h3>
    <p class="muted">Please login to access this feature</p>
    <button onclick="goLogin()">Go to Login</button>
  </div>
</div>


<script>
feather.replace();

/* ================= AUTH ================= */

const token = localStorage.getItem("token");
let isLoggedIn = false;
let USER = null;
let ordersLoaded = false;

const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/847/847969.png";

/* ================= ELEMENTS ================= */

const avatar = document.getElementById("avatar");
const topAvatar = document.getElementById("topAvatar");
const topName = document.getElementById("topName");
const userBox = document.getElementById("userBox");
const greeting = document.getElementById("greeting");

const nameInput = document.getElementById("name");
const emailInput = document.getElementById("email");

/* ================= INIT ================= */

if (!token) {
  guestMode();
} else {
  fetch("/api/user/profile", {
    headers: { Authorization: "Bearer " + token }
  })
  .then(res => {
    if (!res.ok) throw new Error("Auth failed");
    return res.json();
  })
  .then(user => {
    USER = user;
    isLoggedIn = true;
    renderUser();
  })
  .catch(() => {
    localStorage.removeItem("token");
    guestMode();
  });
}

/* ================= UI MODES ================= */

function guestMode(){
  isLoggedIn = false;

  avatar.src = defaultAvatar;
  userBox.style.display = "none";
  greeting.style.display = "none";

  ["points","ordersCount","lifetime"].forEach(id=>{
    document.getElementById(id).innerText="--";
  });
}

function renderUser(){
  greeting.style.display="block";
  document.getElementById("greet").innerText = USER.name || "User";

  userBox.style.display="flex";
  topName.innerText = USER.name || "User";

  avatar.src = USER.profile_image || defaultAvatar;
  topAvatar.src = avatar.src;

  nameInput.value = USER.name || "";
  emailInput.value = USER.email || "";

  document.getElementById("points").innerText = USER.points ?? 0;
  document.getElementById("ordersCount").innerText = USER.orders ?? 0;
  document.getElementById("lifetime").innerText = USER.lifetime ?? "â‚¹0";
}

/* ================= SIDEBAR ================= */

document.querySelectorAll(".sidebar a[data-section]").forEach(btn=>{
  btn.onclick=()=>{
    if(!isLoggedIn && btn.classList.contains("locked")){
      showLoginPrompt();
      return;
    }

    document.querySelectorAll(".sidebar a").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");

    document.querySelectorAll(".section").forEach(sec=>{
      sec.classList.toggle("active", sec.id===btn.dataset.section);
    });

    if(btn.dataset.section==="orders" && !ordersLoaded){
      loadOrders();
      ordersLoaded=true;
    }
  }
});

/* ================= LOGIN PROMPT ================= */

function showLoginPrompt(){
  document.getElementById("loginOverlay").style.display="flex";
}
function goLogin() {
  window.location.href = "http://localhost:5000/login";
}


/* ================= PROFILE SAVE ================= */

function save(){
  if(!isLoggedIn){ showLoginPrompt(); return; }
  alert("Profile update API can be added next");
}

/* ================= LOGOUT ================= */

function logout(){
  localStorage.removeItem("token");
  location.href="/login";
}

/* ================= ORDERS ================= */

function loadOrders(){
  fetch("/api/orders",{
    headers:{Authorization:"Bearer "+token}
  })
  .then(r=>r.ok?r.json():[])
  .then(data=>{
    const list=document.getElementById("ordersList");
    list.innerHTML="";
    if(!data.length){
      list.innerHTML="<p>No orders yet</p>";
      return;
    }
    data.forEach(o=>{
      list.innerHTML+=`<li>${o.product} â€¢ â‚¹${o.amount} â€¢ ${o.status}</li>`;
    });
  })
  .catch(()=>{
    document.getElementById("ordersList").innerHTML="<p>Unable to load orders</p>";
  });
}

/* ================= PASSWORD ================= */

function changePass(){
  if(!isLoggedIn){ showLoginPrompt(); return; }

  if(!oldPass.value || !newPass.value){
    alert("Fill all fields");
    return;
  }

  fetch("/api/user/password",{
    method:"PUT",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token
    },
    body:JSON.stringify({
      oldPass:oldPass.value,
      newPass:newPass.value
    })
  })
  .then(r=>r.json())
  .then(d=>alert(d.msg||"Updated"))
  .catch(()=>alert("Server error"));
}
</script>

</body>
</html>
